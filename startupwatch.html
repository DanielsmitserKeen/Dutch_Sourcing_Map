<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Startup Watch</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gray-50 font-sans">
  <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <h1 class="text-3xl font-extrabold text-gray-900 mb-6">Explore startups by industry</h1>

    <div class="grid grid-cols-12 gap-6">
      <!-- Sidebar -->
      <aside class="col-span-3 bg-white p-4 border rounded-lg h-[80vh] overflow-y-auto">
        <h2 class="text-lg font-semibold mb-4">Filter by Industry</h2>
        <div id="industryFilters" class="space-y-2">
          <!-- Checkboxes injected here -->
        </div>
      </aside>

      <!-- Main Area -->
      <main class="col-span-9">
        <!-- Chat-style input -->
        <div class="mb-6">
          <label for="chatFilter" class="block text-sm font-medium text-gray-700 mb-2">
            Describe company
          </label>
          <input 
            id="chatFilter"
            type="text"
            placeholder="I want to find solar panel installation companies..."
            class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 p-3"
          />
        </div>

        <!-- Startup Grid -->
        <div id="startupGrid" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
          <!-- Cards injected here -->
        </div>
      </main>
    </div>
  </div>

  <script>
    let startups = [];
    let industries = new Set();
    let selectedIndustries = [];

    // Load CSV (replace with your live Google Sheet CSV link)
    fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vTEIrT3TH2GL4XngIpNOqqMptIU2N66LwPqXbg86MFOX6mxnr5SWIsGa7lYtrzuP1mex8n4qjU6bS3Z/pub?gid=753064840&single=true&output=csv")
      .then(res => res.text())
      .then(csv => {
        const parsed = Papa.parse(csv, { header: true });
        startups = parsed.data.filter(s => s.company_name && s.industry);

        // Collect unique industry tags
        startups.forEach(s => {
          s.industry.split(",").forEach(tag => industries.add(tag.trim()));
        });

        renderFilters();
        renderGrid();
      });

    function renderFilters() {
      const container = document.getElementById("industryFilters");
      container.innerHTML = "";

      Array.from(industries).sort().forEach(ind => {
        const wrapper = document.createElement("div");
        wrapper.className = "flex items-center";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = ind;
        checkbox.className = "h-4 w-4 text-blue-600 border-gray-300 rounded";
        checkbox.addEventListener("change", () => {
          if (checkbox.checked) {
            selectedIndustries.push(ind);
          } else {
            selectedIndustries = selectedIndustries.filter(i => i !== ind);
          }
          renderGrid();
        });

        const label = document.createElement("label");
        label.innerText = ind;
        label.className = "ml-2 text-sm text-gray-700";

        wrapper.appendChild(checkbox);
        wrapper.appendChild(label);
        container.appendChild(wrapper);
      });
    }

    function renderGrid(data = null) {
      const container = document.getElementById("startupGrid");
      container.innerHTML = "";

      let filtered = data || startups;

      if (!data && selectedIndustries.length > 0) {
        filtered = startups.filter(s =>
          selectedIndustries.some(ind =>
            s.industry.split(",").map(tag => tag.trim()).includes(ind)
          )
        );
      }

      if (filtered.length === 0) {
        container.innerHTML = `<p class="text-gray-500 col-span-full">No startups found.</p>`;
        return;
      }

      filtered.forEach(s => {
        const card = document.createElement("div");
        card.className = "p-6 bg-white border rounded-lg shadow-sm";

        card.innerHTML = `
          <h3 class="text-lg font-bold text-gray-900">${s.company_name}</h3>
          <p class="mt-2 text-sm text-gray-600">${s.industry}</p>
          <div class="mt-4">
            ${s.domain 
              ? `<a href="https://${s.domain}" target="_blank" class="text-blue-600 hover:underline">${s.domain}</a>` 
              : `<span class="text-gray-400 italic">No website</span>`}
          </div>
        `;
        container.appendChild(card);
      });
    }

    // Chat-style filter
    document.getElementById("chatFilter").addEventListener("keypress", async (e) => {
      if (e.key === "Enter") {
        const query = e.target.value.trim();
        if (!query) return;

        const container = document.getElementById("startupGrid");
        container.innerHTML = `<p class="text-gray-500 col-span-full">Searching...</p>`;

        try {
          const res = await fetch("https://danielsmitserkeen.app.n8n.cloud/webhook-test/startup-search", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query })
          });
          const data = await res.json();

          // Expecting { companies: ["Amplio", "Circularise"] }
          const matched = startups.filter(s =>
            data.companies && data.companies.includes(s.company_name)
          );

          renderGrid(matched);
        } catch (err) {
          container.innerHTML = `<p class="text-red-500 col-span-full">Error fetching results.</p>`;
          console.error(err);
        }
      }
    });
  </script>
</body>
</html>

